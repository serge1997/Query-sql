-- conta frete 311010003 e venda 311010002
WITH CTE AS
(
	SELECT
			SUBSTRING(CT2_KEY,1, 6) FILIAL,
			SUBSTRING(CT2_KEY, 7, 9) NF,
			CT2_VALOR VALOR
		FROM CT2010 WHERE CT2_CREDIT = '311010002'
		AND CT2_DATA LIKE '202310%'
		AND SUBSTRING(CT2_KEY, 7, 9) = '000096554'
)SELECT
		CTE.FILIAL,
		CTE.NF,
		(
			SELECT SUM(F3_VALCONT) FROM SF3010 F3
				WHERE F3.F3_FILIAL = CTE.FILIAL
				AND F3.F3_NFISCAL = CTE.NF
				AND F3.F3_ENTRADA LIKE '202310%'
		) F3_VALCONT,
		CTE.VALOR VALOR_CT2,
		ISNULL(CT.CT2_VALOR, 0) FRETE,
		(
			SELECT MAX(SE.E1_VALOR) FROM SE1010 SE
				WHERE CTE.FILIAL = SE.E1_FILIAL
				AND CTE.NF = SE.E1_NUM
				AND SE.E1_EMISSAO LIKE  '202310%'
		) E1_VALOR
	FROM CTE
		LEFT JOIN CT2010 CT
			ON SUBSTRING(CT.CT2_KEY,1, 6) = CTE.FILIAL
			AND SUBSTRING(CT2_KEY, 7, 9) = CTE.NF
			AND CT.CT2_CREDIT = '311010003'
		
