ALTER VIEW [dbo].[COMISSAO] AS
WITH CTE AS
(
	SELECT
		D2.D2_EMISSAO,
		D2.D2_FILIAL,
		D2.D2_PRCVEN,
		D2.D2_CLIENTE,
		DA.DA1_PRCVEN PRECO_TABELA,
		D2.D2_TOTAL,
		D2.D2_DOC,
		D2.D2_QUANT,
		CASE
			WHEN RTRIM(DA.DA1_CODTAB) = '005' AND D2.D2_PRCVEN >= DA.DA1_PRCVEN THEN (D2.D2_TOTAL * 1.5) / 100
			WHEN RTRIM(DA.DA1_CODTAB) = '006' AND D2.D2_PRCVEN >= DA.DA1_PRCVEN THEN (D2.D2_TOTAL * 2.5) / 100
			WHEN RTRIM(DA.DA1_CODTAB) = '007' AND D2.D2_PRCVEN >= DA.DA1_PRCVEN THEN (D2.D2_TOTAL * 5) / 100
			WHEN RTRIM(DA.DA1_CODTAB) = '008' AND D2.D2_PRCVEN >= DA.DA1_PRCVEN THEN (D2.D2_TOTAL * 7.5) / 100
			WHEN RTRIM(DA.DA1_CODTAB) = '009' AND D2.D2_PRCVEN >= DA.DA1_PRCVEN THEN (D2.D2_TOTAL * 10) / 100
		ELSE 0
		END COMISSAO,
		D2.D2_COD,
		DA.DA1_CODTAB,
		ROUND(((D2_PRCVEN / NULLIF(DA.DA1_PRCVEN, 0) -1)*100) * (-1), 2) DIFERENÇA,
		D2.D2_QUANT * D2.D2_PRCVEN BASE_COMISAO
	FROM SD2010 D2
		INNER JOIN DA1010 DA
			ON RTRIM(D2.D2_COD) = RTRIM(DA.DA1_CODPRO)
			AND DA.D_E_L_E_T_ <> '*'
	WHERE D2.D2_EMISSAO LIKE '%202305%'
		--AND D2.D2_DOC = '000005385'
		AND DA.DA1_CODTAB IN 
	(
		'005',
		'006',
		'007',
		'008',
		'009'
	)
UNION ALL
SELECT
		SD1.D1_EMISSAO D2_EMISSAO,
		SD1.D1_FILIAL D2_FILIAL,
		SD2.D2_PRCVEN,
		SD2.D2_CLIENTE,
		DA.DA1_PRCVEN PRECO_TABELA,
		SD1.D1_TOTAL * (-1) D2_TOTAL,
		SD1.D1_NFORI D2_DOC,
		SD1.D1_QUANT D2_QUANT,
		CASE
			WHEN RTRIM(DA.DA1_CODTAB) = '005' AND SD2.D2_PRCVEN >= DA.DA1_PRCVEN THEN (SD2.D2_TOTAL * 1.5) / 100
			WHEN RTRIM(DA.DA1_CODTAB) = '006' AND SD2.D2_PRCVEN >= DA.DA1_PRCVEN THEN (SD2.D2_TOTAL * 2.5) / 100
			WHEN RTRIM(DA.DA1_CODTAB) = '007' AND SD2.D2_PRCVEN >= DA.DA1_PRCVEN THEN (SD2.D2_TOTAL * 5) / 100
			WHEN RTRIM(DA.DA1_CODTAB) = '008' AND SD2.D2_PRCVEN >= DA.DA1_PRCVEN THEN (SD2.D2_TOTAL * 7.5) / 100
			WHEN RTRIM(DA.DA1_CODTAB) = '009' AND SD2.D2_PRCVEN >= DA.DA1_PRCVEN THEN (SD2.D2_TOTAL * 10) / 100
		ELSE 0
		END COMISSAO,
		SD2.D2_COD,
		DA.DA1_CODTAB,
		ROUND(((D2_PRCVEN / NULLIF(DA.DA1_PRCVEN, 0) -1)*100) * (-1), 2) DIFERENÇA,
		SD2.D2_QUANT * SD2.D2_PRCVEN BASE_COMISAO
	FROM SD2010 SD2
		INNER JOIN SD1010 SD1
			ON SD1.D1_FILIAL = SD2.D2_FILIAL
			AND SD1.D1_NFORI = SD2.D2_DOC
			AND SD1.D1_SERIORI = SD2.D2_SERIE
			AND SD1.D1_ITEMORI = SD2.D2_ITEM
			AND SD1.D_E_L_E_T_ <> '*'
		INNER JOIN DA1010 DA
			ON RTRIM(SD2.D2_COD) = RTRIM(DA.DA1_CODPRO)
			AND DA.D_E_L_E_T_ <> '*'
	WHERE SD2.D2_EMISSAO LIKE '%202305%'
		--AND D2.D2_DOC = '000005385'
		AND DA.DA1_CODTAB IN 
	(
		'005',
		'006',
		'007',
		'008',
		'009'
	)
)SELECT
		D2_DOC,
		D2_QUANT,
		D2_COD,
		PRECO_TABELA,
		D2_PRCVEN,
		D2_TOTAL,
		DA1_CODTAB,
		D2_CLIENTE,
		MAX(COMISSAO) COMISSAO
FROM CTE 
--WHERE PRECO_TABELA > 0
GROUP BY
		D2_DOC,
		D2_QUANT,
		D2_COD,
		PRECO_TABELA,
		D2_PRCVEN,
		D2_TOTAL,
		DA1_CODTAB,
		D2_CLIENTE
GO


